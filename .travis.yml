language: bash
sudo: required

if: branch = build

services:
- docker

env:
  global:
    - CACHE_DIR=$HOME/.cache/docker
    - FROM_STAGE=1
    - TO_STAGE=4
    # first few stages are faster to get from disk than the
    # network, despite what the Travis docco says
    - NUM_STAGES_TO_CACHE=3
    - IMG=phlummox/aarch64-cross-compiler
    - VERSION=0.1

cache:
  directories:
  - $CACHE_DIR

before_install:
- |
  bash travis_load_from_cache.sh $CACHE_DIR 1 $TO_STAGE $NUM_STAGES_TO_CACHE
  bash docker_pull.sh $FROM_STAGE $TO_STAGE


script:
- bash docker_build.sh $FROM_STAGE $TO_STAGE
- docker images
- bash travis_save_cache.sh $CACHE_DIR $FROM_STAGE $TO_STAGE $NUM_STAGES_TO_CACHE
# ensure we have some images
- docker images | grep phlummox/aarch64-cross-compiler
# use it
#- docker
#- export

deploy:
  - provider: script
    skip_cleanup: true
    script: bash docker_push.sh $FROM_STAGE $TO_STAGE $VERSION
    on:
      branch: build
#  - deploy:
#      provider: releases
#      api_key: "GITHUB OAUTH TOKEN"
#      file: "FILE TO UPLOAD"
#      skip_cleanup: true
#      draft: true
#      # ^^ TODO: remove
#      on:
#        #tags: true
#        branch: build
